# AppVeyor config for MPF-MC
# This config based on https://packaging.python.org/en/latest/appveyor/

environment:

  matrix:
    - PYTHON: "C:\\Python34"
      PLAT_NAME: "win32"
    - PYTHON: "C:\\Python34-x64"
      PLAT_NAME: "win_amd64"

  pypi_user:
    secure: kxNKBuVMdOz6LjJPQb7PMQ==

  pypi_password:
    secure: nmmwU7UgFbrGUJwIr0Vo6cHzCuxlvW4vjg9TjkwrjmE=

install:
  - "%PYTHON%\\python.exe -m pip install -U setuptools wheel pip mock gitpython twine"
  - "git clone -q --branch=dev --recursive https://github.com/missionpinball/mpf.git C:\\projects\\mpf"

  - "cd build_scripts"
  - "%PYTHON%\\python.exe calculate_mpf_branch.py"
  - "checkout_mpf_branch.bat"  # auto generated by calculate_mpf_branch.py

    # install mpf. Branch was set by checkout_mpf_branch.bat
  - "cd \\projects\\mpf"
  - "%PYTHON%\\python.exe -m pip install ."  # installs mpf
  - "cd \\projects\\mpf-mc"

  - "copy c:\\projects\\mpf-mc\\build_scripts\\distutils.cfg %PYTHON%\\Lib\\distutils\\distutils.cfg"
  - "%PYTHON%\\python.exe -m pip install -i https://pypi.anaconda.org/carlkl/simple mingwpy --cache-dir C:\\tmp_%PLAT_NAME%\\mingwpy"
  - "set USE_SDL2=1"
  - "set USE_GSTREAMER=1"
  - "%PYTHON%\\python.exe -m pip install Cython==0.24.1 docutils pygments pypiwin32 kivy.deps.sdl2 kivy.deps.glew kivy.deps.glew_dev kivy.deps.sdl2_dev kivy.deps.gstreamer_dev --cache-dir C:\\tmp_%PLAT_NAME%\\deps"
  - "%PYTHON%\\python.exe -m pip install kivy.deps.gstreamer --extra-index-url https://mpf.kantert.net/simple/ --cache-dir C:\\tmp_%PLAT_NAME%\\gstreamer"
  # AppVeyor has its own mingw, so we have to put the one we just installed in the front of the path
  - "set PATH=%PYTHON%\\share\\mingwpy\\bin;%PYTHON%\\Scripts;%PATH%"
  - "%PYTHON%\\python.exe -m pip install ."  # installs mpf-mc

build: off

test_script:
#  - "%PYTHON%\\python.exe -m unittest discover -s mpfmc/tests"
  - "echo SKIPPING TESTS"

after_test:
  - "%PYTHON%\\python.exe setup.py bdist_wheel --plat-name %PLAT_NAME%"
  - "%PYTHON%\\python.exe setup.py sdist --formats=gztar"
  - "cd dist"
  - "%PYTHON%\\python.exe ../build_scripts/rename_wheels.py"

artifacts:
  - path: dist\*

deploy_script:
  - "cd \\projects\\mpf-mc\\dist"
  - "%PYTHON%\\python.exe -m twine upload -u %pypi_user% -p %pypi_password% --skip-existing *"

cache:
  - "C:\\tmp_%PLAT_NAME%\\mingwpy -> appveyor.yml"
  - "C:\\tmp_%PLAT_NAME%\\deps -> appveyor.yml"
  - "C:\\tmp_%PLAT_NAME%\\gstreamer -> appveyor.yml"
